name: Backup Vercel Configuration

on:
  schedule:
    # Backup hebdomadaire dimanche Ã  5h UTC
    - cron: '0 5 * * 0'
  workflow_dispatch: # Permet dÃ©clenchement manuel

jobs:
  backup-vercel:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Vercel CLI
        run: |
          npm install -g vercel@latest
          vercel --version
      
      - name: Authenticate Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "$VERCEL_TOKEN" | vercel login --token
      
      - name: Backup Vercel Environment Variables
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "ðŸ”„ Backup des variables d'environnement Vercel..."
          
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BACKUP_DIR="vercel-backups"
          mkdir -p "$BACKUP_DIR"
          
          # Lister toutes les variables d'environnement (avec projet spÃ©cifiÃ©)
          if [ -n "$VERCEL_PROJECT_ID" ]; then
            vercel env ls --project="$VERCEL_PROJECT_ID" > "$BACKUP_DIR/vercel-env-$TIMESTAMP.txt" 2>&1 || echo "âš ï¸  Impossible de lister les variables"
            
            # Exporter les variables (avec projet et environnement spÃ©cifiÃ©s)
            vercel env pull .env.vercel.backup --project="$VERCEL_PROJECT_ID" --environment=production 2>&1 || echo "âš ï¸  Impossible d'exporter les variables"
          else
            # Sans projet spÃ©cifiÃ©, essayer sans
            vercel env ls > "$BACKUP_DIR/vercel-env-$TIMESTAMP.txt" 2>&1 || echo "âš ï¸  Impossible de lister les variables"
            vercel env pull .env.vercel.backup --environment=production 2>&1 || echo "âš ï¸  Impossible d'exporter les variables"
          fi
          
          if [ -f ".env.vercel.backup" ]; then
            mv .env.vercel.backup "$BACKUP_DIR/vercel-env-$TIMESTAMP.env"
          fi
          
          echo "âœ… Backup Vercel crÃ©Ã©"
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: the-experience-477712-h0
      
      - name: Upload to GCS
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BACKUP_DIR="vercel-backups"
          
          # Compresser les backups
          if [ -d "$BACKUP_DIR" ] && [ "$(ls -A $BACKUP_DIR)" ]; then
            tar -czf "vercel-backup-$TIMESTAMP.tar.gz" "$BACKUP_DIR"
            
            # Upload vers GCS
            gsutil cp "vercel-backup-$TIMESTAMP.tar.gz" \
              "gs://flourishnow-backups-weekly/vercel/vercel-backup-$TIMESTAMP.tar.gz"
            
            echo "âœ… Backup Vercel uploadÃ© vers GCS"
            
            # Nettoyer
            rm -rf "$BACKUP_DIR" "vercel-backup-$TIMESTAMP.tar.gz"
          else
            echo "âš ï¸  Aucun backup Vercel Ã  uploader"
          fi
      
      - name: Cleanup old backups
        run: |
          echo "ðŸ§¹ Nettoyage des anciens backups Vercel..."
          
          # Supprimer les backups > 4 semaines
          gsutil -m ls -l "gs://flourishnow-backups-weekly/vercel/" 2>/dev/null | \
            awk '{print $2, $3}' | \
            while read size date file; do
              file_date=$(date -d "$date" +%s 2>/dev/null || echo 0)
              weeks_old=$(( ($(date +%s) - file_date) / 604800 ))
              if [ $weeks_old -gt 4 ] && [ -n "$file" ]; then
                echo "  Suppression: $file (${weeks_old} semaines)"
                gsutil rm "$file" 2>/dev/null || true
              fi
            done
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“‹ RÃ©sumÃ© du Backup Vercel" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Backup Vercel terminÃ©" >> $GITHUB_STEP_SUMMARY
